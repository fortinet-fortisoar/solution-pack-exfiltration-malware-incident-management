{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": ">> Get Indicator Related Events",
    "aliasName": null,
    "tag": null,
    "description": "Get and link indicator related events",
    "isActive": true,
    "debug": true,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "indicator",
        "reptDevIpAddr"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/26d51696-4c4a-4f19-aabe-70fa9c9bbf2d",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/3e4cf09b-8533-461a-8a08-bfc43614f9c5",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Build Search Query",
            "description": null,
            "arguments": {
                "query": "reptDevIpAddr = {{vars.reptDevIpAddr}} AND  rawEventMsg CONTAIN \"{{vars.indicator.value}}\"",
                "mockdata": "{\n  \"File\": {\n    \"search_results\": {\n      \"@start\": \"0\",\n      \"events\": [\n        {\n          \"id\": \"5071756881441641913\",\n          \"nid\": \"5071756881441641913\",\n          \"index\": \"0\",\n          \"custId\": \"1\",\n          \"dataStr\": null,\n          \"infoURL\": \"http:\/\/www.arcademia.biz\/38482980\/Stock_Analysis_Report.docx\",\n          \"eventType\": \"FortiGate-traffic-allowed\",\n          \"attributes\": {\n            \"eventName\": \"FortiGate-traffic-allowed\",\n            \"eventType\": \"FortiGate-traffic-allowed\",\n            \"phRecvTime\": \"Wed Oct 19 03:41:37 GST 2022\",\n            \"rawEventMsg\": \"<190>date={{arrow.now().format(\"YYYY-MM-DD\")}} time={{arrow.now().shift(minutes=-63).format(\"HH:mm:ss\")}} devname=\\\"FortiGate-Core\\\" devid=\\\"FGVM99TM21098013\\\" eventtime={{arrow.now().int_timestamp * 1000000000}} tz=\\\"+0000\\\" logid=\\\"1059028704\\\" type=\\\"utm\\\" subtype=\\\"app-ctrl\\\" eventtype=\\\"signature\\\" level=\\\"information\\\" vd=\\\"root\\\" appid=15893 srcip={{vars.reptDevIpAddr}} srccountry=\\\"Reserved\\\" dstip=188.184.21.108 dstcountry=\\\"Switzerland\\\" srcport=47648 dstport=80 srcintf=\\\"port2\\\" srcintfrole=\\\"dmz\\\" dstintf=\\\"port5\\\" dstintfrole=\\\"wan\\\" proto=6 service=\\\"HTTPS\\\" direction=\\\"outgoing\\\" policyid=3 poluuid=\\\"a1cdcc14-f7e0-51e9-2c1c-0be23092896e\\\" policytype=\\\"policy\\\" sessionid=22471879 applist=\\\"default\\\" action=\\\"pass\\\" appcat=\\\"Web.Client\\\" app=\\\"HTTP.BROWSER\\\" hostname=\\\"www.arcademia.biz\\\" incidentserialno=1026 url=\\\"\/38482980\/Stock_Analysis_Report.docx\\\" agent=\\\"Mozilla\/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/106.0.0.0 Safari\/537.36\\\" httpmethod=\\\"GET\\\" msg=\\\"Web.Client: HTTP.BROWSER\\\" apprisk=\\\"medium\\\"\\\",\\\"reptDevIpAddr\\\": \\\"{{vars.reptDevIpAddr}}\\\"\"\n          },\n          \"receiveTime\": \"{{arrow.now().shift(minutes=-80).int_timestamp}}\"\n        }\n      ],\n      \"@queryId\": \"23206,1666154506541\",\n      \"@errorCode\": \"0\",\n      \"@totalCount\": \"48289\"\n    },\n    \"status\": \"finished\"\n  }\n}"
            },
            "status": null,
            "top": "165",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "a0ef69aa-39e0-499a-96f0-f41b2a2c7a94"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Events",
            "description": null,
            "arguments": {
                "when": "{{vars.fetched_events|length > 0}}",
                "for_each": {
                    "item": "{{vars.fetched_events}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "name": "{{vars.item.attributes.eventType}}",
                    "__link": {
                        "indicators": "{{vars.indicator['@id']}}"
                    },
                    "source": "FortiSIEM",
                    "sourceId": "{{vars.item.id}}",
                    "__replace": "",
                    "eventTime": "{{vars.item.receiveTime}}",
                    "reporterIP": "{{vars.reptDevIpAddr}}",
                    "searchName": false,
                    "description": "### Notable Attributes:\n\n- URL: {{vars.item.infoURL}}\n- Event Type: {{vars.item.eventType}}\n- Receive Time {{vars.item.receiveTime}}\n",
                    "rawEventLog": "{{vars.item.attributes.rawEventMsg}}",
                    "searchReporterIP": false
                },
                "operation": "Append",
                "collection": "\/api\/3\/events",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "e26219fe-dea3-4f85-bacc-7e46317c44da"
        },
        {
            "@type": "WorkflowStep",
            "name": "Parse Search Results",
            "description": null,
            "arguments": {
                "fetched_events": "{{vars.steps.Run_Search_Query.search_results.events}}"
            },
            "status": null,
            "top": "435",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "e16b136d-a858-4364-a2cc-9ca1f757cf3e"
        },
        {
            "@type": "WorkflowStep",
            "name": "Run Search Query",
            "description": null,
            "arguments": {
                "name": "Fortinet FortiSIEM",
                "config": "16cc927a-a856-4766-b2fb-75e5e3936c71",
                "params": {
                    "cond": "{{vars.query}}",
                    "start": 0,
                    "value": 1,
                    "groupby": "",
                    "orderby": "phRecvTime DESC",
                    "perPage": 1,
                    "AttrList": "phRecvTime,reptDevIpAddr,eventType,eventName,infoURL,rawEventMsg,swProcName,user",
                    "rel_time": "Hours",
                    "time_selection": "Relative Time"
                },
                "version": "5.0.1",
                "connector": "fortinet-fortisiem",
                "operation": "run_report",
                "mock_result": "{{vars.mockdata[vars.indicator.typeofindicator.itemValue]}}",
                "operationTitle": "Run Advanced Search Query",
                "step_variables": {
                    "hunt_results": "{{vars.result.data}}"
                }
            },
            "status": null,
            "top": "300",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "f47d3865-6db8-426d-9d25-07c7d2058043"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    },
                    "indicator": "{{vars.input.params.indicator}}",
                    "reptDevIpAddr": "{{vars.input.params.reptDevIpAddr}}",
                    "useMockOutput": "{{globalVars.Demo_mode}}"
                }
            },
            "status": null,
            "top": "30",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "3e4cf09b-8533-461a-8a08-bfc43614f9c5"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Build Search Query -> Run Search Query",
            "targetStep": "\/api\/3\/workflow_steps\/f47d3865-6db8-426d-9d25-07c7d2058043",
            "sourceStep": "\/api\/3\/workflow_steps\/a0ef69aa-39e0-499a-96f0-f41b2a2c7a94",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "a942b255-caa3-4775-8c6d-73e689b84dd6"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Parse Search Results -> Create Event",
            "targetStep": "\/api\/3\/workflow_steps\/e26219fe-dea3-4f85-bacc-7e46317c44da",
            "sourceStep": "\/api\/3\/workflow_steps\/e16b136d-a858-4364-a2cc-9ca1f757cf3e",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "9812a57c-d523-4740-9381-f3b6aa342ba3"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Run Search Query -> Parse Search Results",
            "targetStep": "\/api\/3\/workflow_steps\/e16b136d-a858-4364-a2cc-9ca1f757cf3e",
            "sourceStep": "\/api\/3\/workflow_steps\/f47d3865-6db8-426d-9d25-07c7d2058043",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "2844ee01-4447-4d00-9381-03cb8b3e7e8e"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Build Search Query",
            "targetStep": "\/api\/3\/workflow_steps\/a0ef69aa-39e0-499a-96f0-f41b2a2c7a94",
            "sourceStep": "\/api\/3\/workflow_steps\/3e4cf09b-8533-461a-8a08-bfc43614f9c5",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "28a50ad1-c94e-403b-9235-ba23b7f99ac3"
        }
    ],
    "groups": [],
    "priority": null,
    "uuid": "8fb70603-5112-4d78-987c-325705f6f12d",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Threat Hunting",
        "Events"
    ]
}